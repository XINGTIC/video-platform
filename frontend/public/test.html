<!DOCTYPE html>
<html>
<head>
    <title>Video Test</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; font-size: 16px; }
        pre { background: #f0f0f0; padding: 15px; overflow: auto; max-height: 300px; white-space: pre-wrap; word-wrap: break-word; }
        .error { color: red; }
        .success { color: green; }
        #video { background: #000; }
    </style>
</head>
<body>
    <h1>视频调试测试</h1>
    
    <div id="status" style="padding:10px;background:#ffffcc;margin-bottom:20px;">正在初始化...</div>
    
    <h2>1. API 测试</h2>
    <button id="btnTestAPI">测试 API</button>
    <button id="btnTestProxy">测试代理</button>
    <button id="btnTestDirect">测试直接访问</button>
    <pre id="apiResult">点击按钮开始测试</pre>
    
    <h2>2. 视频播放器</h2>
    <video id="video" width="640" height="360" controls></video>
    <br><br>
    <button id="btnLoadVideo">加载视频</button>
    
    <h2>3. 日志</h2>
    <pre id="logs"></pre>

    <script>
        const API_URL = 'https://video-platform-3v33.onrender.com/api';
        let videoData = null;
        
        function log(msg, isError) {
            const logs = document.getElementById('logs');
            const time = new Date().toISOString().substr(11,8);
            const line = document.createElement('div');
            line.textContent = time + ' ' + msg;
            if (isError) line.className = 'error';
            logs.appendChild(line);
            logs.scrollTop = logs.scrollHeight;
            console.log(msg);
        }
        
        function setStatus(msg, isError) {
            const status = document.getElementById('status');
            status.textContent = msg;
            status.style.background = isError ? '#ffcccc' : '#ccffcc';
        }
        
        async function testAPI() {
            log('=== 开始 API 测试 ===');
            const result = document.getElementById('apiResult');
            result.textContent = '测试中...';
            
            try {
                // 1. Test health
                log('检查后端健康状态...');
                const healthRes = await fetch(API_URL + '/health');
                const healthData = await healthRes.json();
                log('后端状态: ' + JSON.stringify(healthData));
                
                // 2. Get video list
                log('获取视频列表...');
                const listRes = await fetch(API_URL + '/videos?limit=1');
                const listData = await listRes.json();
                log('视频数量: ' + listData.totalVideos);
                
                if (!listData.videos || listData.videos.length === 0) {
                    log('没有找到视频!', true);
                    result.textContent = '数据库中没有视频';
                    return;
                }
                
                const videoId = listData.videos[0]._id;
                log('视频 ID: ' + videoId);
                
                // 3. Check token
                const token = localStorage.getItem('token');
                log('Token 存在: ' + (token ? '是' : '否'));
                
                if (!token) {
                    log('请先登录! 访问 /login 页面登录', true);
                    setStatus('请先登录!', true);
                    result.textContent = '未登录 - 请先访问 /login 登录';
                    return;
                }
                
                // 4. Get video details
                log('获取视频详情...');
                const detailRes = await fetch(API_URL + '/videos/' + videoId, {
                    headers: { Authorization: 'Bearer ' + token }
                });
                
                if (!detailRes.ok) {
                    const errText = await detailRes.text();
                    log('获取视频失败: ' + detailRes.status + ' ' + errText, true);
                    result.textContent = '错误 ' + detailRes.status + ': ' + errText;
                    return;
                }
                
                videoData = await detailRes.json();
                log('视频标题: ' + videoData.title);
                log('视频 URL: ' + videoData.videoUrl);
                log('来源 URL: ' + videoData.sourceUrl);
                log('Provider: ' + videoData.provider);
                
                result.textContent = JSON.stringify(videoData, null, 2);
                setStatus('API 测试成功! 点击"加载视频"播放', false);
                
            } catch (e) {
                log('API 错误: ' + e.message, true);
                result.textContent = '错误: ' + e.message;
                setStatus('API 测试失败', true);
            }
        }
        
        async function testProxy() {
            if (!videoData || !videoData.videoUrl) {
                log('请先运行 API 测试', true);
                return;
            }
            
            log('=== 测试代理 ===');
            const proxyUrl = API_URL + '/proxy?url=' + encodeURIComponent(videoData.videoUrl) + '&referer=' + encodeURIComponent('https://h823.sol148.com/');
            log('代理 URL: ' + proxyUrl);
            
            try {
                const res = await fetch(proxyUrl);
                log('代理状态码: ' + res.status);
                log('Content-Type: ' + res.headers.get('content-type'));
                log('Content-Length: ' + res.headers.get('content-length'));
                
                if (res.status !== 200 && res.status !== 206) {
                    const text = await res.text();
                    log('错误响应: ' + text, true);
                    return;
                }
                
                // 读取前100字节
                const reader = res.body.getReader();
                const { value } = await reader.read();
                reader.cancel();
                
                if (value) {
                    log('收到数据: ' + value.length + ' 字节');
                    // 检查是否是视频数据
                    const header = Array.from(value.slice(0, 8)).map(b => b.toString(16).padStart(2, '0')).join(' ');
                    log('文件头 (hex): ' + header);
                    
                    // MP4 通常以 00 00 00 xx 66 74 79 70 (ftyp) 开头
                    const asText = new TextDecoder().decode(value.slice(0, 20));
                    if (asText.includes('ftyp')) {
                        log('检测到有效的 MP4 文件!');
                    } else if (asText.includes('#EXTM3U')) {
                        log('检测到 M3U8 播放列表');
                    } else {
                        log('响应内容: ' + asText.substring(0, 50));
                    }
                }
            } catch (e) {
                log('代理错误: ' + e.message, true);
            }
        }
        
        // 测试直接访问原始URL（会有CORS错误，但可以看到请求是否发出）
        async function testDirect() {
            if (!videoData || !videoData.videoUrl) {
                log('请先运行 API 测试', true);
                return;
            }
            log('=== 测试直接访问 ===');
            log('原始 URL: ' + videoData.videoUrl);
            try {
                const res = await fetch(videoData.videoUrl, { mode: 'no-cors' });
                log('直接访问: 请求已发送 (no-cors模式无法读取响应)');
            } catch (e) {
                log('直接访问错误: ' + e.message, true);
            }
        }
        
        function loadVideo() {
            if (!videoData || !videoData.videoUrl) {
                log('请先运行 API 测试', true);
                alert('请先点击"测试 API"按钮');
                return;
            }
            
            log('=== 加载视频 ===');
            const video = document.getElementById('video');
            const originalUrl = videoData.videoUrl;
            const referer = videoData.sourceUrl || 'https://h823.sol148.com/';
            const proxyUrl = API_URL + '/proxy?url=' + encodeURIComponent(originalUrl) + '&referer=' + encodeURIComponent(referer);
            
            log('原始 URL: ' + originalUrl);
            
            const isHLS = originalUrl.toLowerCase().includes('.m3u8') || originalUrl.toLowerCase().includes('m3u8');
            const isMP4 = originalUrl.toLowerCase().includes('.mp4');
            log('是否 HLS: ' + isHLS);
            log('是否 MP4: ' + isMP4);
            
            // MP4 直接播放，不使用代理
            const finalUrl = isMP4 ? originalUrl : proxyUrl;
            log('最终播放 URL: ' + (isMP4 ? '直接播放' : '通过代理'));
            log('URL: ' + finalUrl.substring(0, 80) + '...');
            log('HLS.js 支持: ' + Hls.isSupported());
            
            if (isHLS) {
                // HLS 格式 - 使用代理
                if (Hls.isSupported()) {
                    log('使用 HLS.js 播放');
                    
                    const hls = new Hls({
                        debug: false,
                        enableWorker: true
                    });
                    
                    hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                        log('HLS Manifest 解析成功! 级别数: ' + data.levels.length);
                        setStatus('视频加载成功!', false);
                        video.play().catch(function(e) {
                            log('自动播放被阻止: ' + e.message);
                        });
                    });
                    
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        log('HLS 错误: ' + data.type + ' - ' + data.details, true);
                        if (data.fatal) {
                            log('致命错误! 视频无法播放', true);
                            setStatus('视频加载失败: ' + data.details, true);
                        }
                    });
                    
                    hls.loadSource(proxyUrl);
                    hls.attachMedia(video);
                    log('HLS 已附加到视频元素');
                    
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    log('使用 Safari 原生 HLS');
                    video.src = proxyUrl;
                    video.play().catch(function(e) { log('播放错误: ' + e.message, true); });
                } else {
                    log('浏览器不支持 HLS', true);
                }
            } else {
                // MP4 或其他格式 - 直接播放原始 URL（不使用代理）
                log('使用直接播放模式 (MP4)');
                log('设置视频源: ' + finalUrl.substring(0, 60) + '...');
                video.src = finalUrl;
                
                video.onloadeddata = function() {
                    log('视频数据已加载!');
                    setStatus('视频加载成功!', false);
                };
                
                video.onerror = function(e) {
                    const errCode = video.error ? video.error.code : 'unknown';
                    const errMsg = video.error ? video.error.message : '未知错误';
                    log('视频加载错误: code=' + errCode + ', msg=' + errMsg, true);
                    log('尝试使用代理模式...', false);
                    // 如果直接播放失败，尝试使用代理
                    video.src = proxyUrl;
                    setStatus('尝试代理模式...', false);
                };
                
                video.play().catch(function(e) { 
                    log('自动播放被阻止: ' + e.message); 
                });
            }
        }
        
        // Bind events
        document.getElementById('btnTestAPI').onclick = testAPI;
        document.getElementById('btnTestProxy').onclick = testProxy;
        document.getElementById('btnTestDirect').onclick = testDirect;
        document.getElementById('btnLoadVideo').onclick = loadVideo;
        
        // Auto init
        setStatus('准备就绪。请点击"测试 API"开始。', false);
        log('页面加载完成');
        log('API URL: ' + API_URL);
    </script>
</body>
</html>

